<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Your Takaful Quote - Shariah-Compliant Home Insurance</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary-gold: #D4AF37;
            --dark-gold: #B8941F;
            --light-gold: #F4E4A6;
            --deep-blue: #0B2545;
            --navy: #1e3a5f;
            --emerald: #2E8B57;
            --mint: #40E0D0;
            --cream: #FAF8F3;
            --pearl: #FEFDF8;
            --text-dark: #1A1A1A;
            --text-light: #6B7280;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.25);
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--deep-blue) 0%, var(--navy) 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Islamic Patterns */
        .islamic-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            background: 
                radial-gradient(circle at 25% 25%, var(--primary-gold) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, var(--emerald) 1px, transparent 1px);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            pointer-events: none;
            z-index: 1;
            animation: patternFloat 20s ease-in-out infinite;
        }

        /* Header */
        .header {
            padding: 2rem 0;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .logo {
            font-family: 'Amiri', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-gold);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .logo::before {
            content: '☪';
            font-size: 2rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            font-weight: 300;
        }

        /* Main Container */
        .quote-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 10;
        }

        /* Conversation Card */
        .conversation-card {
            background: white;
            border-radius: 25px;
            padding: 0;
            box-shadow: 
                0 25px 60px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            min-height: 600px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
        }

        .conversation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-gold), var(--emerald), var(--mint));
        }

        /* Chat Header */
        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--cream);
        }

        .agent-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-gold), var(--emerald));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .agent-info h3 {
            font-family: 'Amiri', serif;
            color: var(--deep-blue);
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }

        .agent-info p {
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--emerald);
            font-size: 0.85rem;
        }

        .typing-dots {
            display: flex;
            gap: 0.2rem;
        }

        .typing-dots span {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--emerald);
            animation: typingDot 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            max-height: 400px;
            scroll-behavior: smooth;
            transition: max-height 0.3s ease;
        }

        /* Reduce chat messages height when options are active */
        .chat-messages.with-options {
            max-height: 250px;
        }

        .message {
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            animation: messageSlideIn 0.5s ease forwards;
        }

        .message.agent {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-gold), var(--emerald));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            flex-shrink: 0;
        }

        .message-content {
            background: var(--cream);
            padding: 1rem 1.5rem;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            max-width: 80%;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-gold), var(--emerald));
            color: white;
            border-radius: 20px;
            border-bottom-right-radius: 5px;
            border-bottom-left-radius: 20px;
        }

        /* Input Area */
        .chat-input {
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            background: white;
        }

        .input-container {
            display: none;
            gap: 1rem;
            align-items: flex-end;
        }

        .input-container.active {
            display: flex;
        }

        .form-input {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid #E5E7EB;
            border-radius: 25px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            font-family: 'Poppins', sans-serif;
            resize: none;
            min-height: 50px;
            max-height: 120px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .send-button {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-gold), var(--emerald));
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Option Buttons */
        .options-container {
            display: none;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .options-container.active {
            display: flex;
        }

        /* Scrollbar styling for options */
        .options-container::-webkit-scrollbar {
            width: 6px;
        }

        .options-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .options-container::-webkit-scrollbar-thumb {
            background: var(--primary-gold);
            border-radius: 3px;
            opacity: 0.7;
        }

        .options-container::-webkit-scrollbar-thumb:hover {
            background: var(--dark-gold);
        }

        .option-button {
            background: var(--cream);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 1rem 1.5rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .option-button:hover {
            transform: translateX(5px);
            border-color: var(--primary-gold);
            background: rgba(212, 175, 55, 0.05);
        }

        .option-icon {
            font-size: 1.5rem;
            width: 35px;
            text-align: center;
        }

        .option-text {
            flex: 1;
        }

        .option-title {
            font-weight: 600;
            color: var(--deep-blue);
            margin-bottom: 0.25rem;
        }

        .option-desc {
            color: var(--text-light);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* Progress Indicator */
        .progress-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 3rem 2rem;
            height: 500px;
        }

        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--primary-gold), var(--emerald));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-title {
            font-family: 'Amiri', serif;
            font-size: 2rem;
            color: var(--deep-blue);
            margin-bottom: 1rem;
        }

        .welcome-subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 3rem;
            line-height: 1.6;
        }

        .start-button {
            background: linear-gradient(135deg, var(--primary-gold), var(--emerald));
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s ease;
            font-family: 'Poppins', sans-serif;
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(212, 175, 55, 0.4);
        }

        /* Loading Animation */
        .loading {
            display: none;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(212, 175, 55, 0.2);
            border-top: 3px solid var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        /* Animations */
        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes patternFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .quote-container {
                padding: 0 1rem;
            }
            
            .chat-messages {
                padding: 1.5rem 1rem;
            }
            
            .chat-input {
                padding: 1rem;
            }
            
            .welcome-screen {
                padding: 2rem 1rem;
            }
            
            .welcome-title {
                font-size: 1.7rem;
            }
            
            .message-content {
                max-width: 90%;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 1rem 0;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .conversation-card {
                border-radius: 15px;
                margin: 0;
            }
        }

        /* Hide elements initially */
        .chat-interface {
            display: none;
        }

        .chat-interface.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="islamic-pattern"></div>
    
    <div class="header">
        <a href="#" class="logo">Takaful</a>
        <p class="header-subtitle">Assalamu Alaikum! Let's get you protected with Shariah-compliant insurance</p>
    </div>

    <div class="quote-container">
        <div class="conversation-card">
            <div class="progress-indicator">
                <span id="progressText">Getting Started</span>
            </div>

            <!-- Welcome Screen -->
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-icon">🏠</div>
                <h2 class="welcome-title">Welcome to Takaful Home Insurance</h2>
                <p class="welcome-subtitle">
                    Get a personalized, Shariah-compliant home insurance quote in just a few minutes. 
                    Our AI assistant will guide you through each step.
                </p>
                <button class="start-button" onclick="startConversation()">
                    Start My Quote Journey →
                </button>
            </div>

            <!-- Chat Interface -->
            <div class="chat-interface" id="chatInterface">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="agent-avatar">🤖</div>
                    <div class="agent-info">
                        <h3>Aisha - Takaful Assistant</h3>
                        <p>Shariah-Compliant Insurance Specialist</p>
                    </div>
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        Aisha is typing...
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be dynamically added here -->
                </div>

                <!-- Chat Input -->
                <div class="chat-input">
                    <!-- Text Input -->
                    <div class="input-container" id="textInput">
                        <input type="text" class="form-input" id="userInput" placeholder="Type your answer..." />
                        <button class="send-button" onclick="sendMessage()" id="sendBtn">
                            ➤
                        </button>
                    </div>

                    <!-- Options -->
                    <div class="options-container" id="optionsContainer">
                        <!-- Options will be dynamically added here -->
                    </div>

                    <!-- Loading -->
                    <div class="loading" id="loadingIndicator">
                        <div class="spinner"></div>
                        <span>Processing...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Credit -->
    <div style="text-align: center; padding: 2rem 0; color: rgba(255, 255, 255, 0.5);">
        <p style="font-size: 0.9rem;">
            Powered by <a href="https://dataorbitllc.com" target="_blank" style="color: var(--primary-gold); text-decoration: none; font-weight: 500;" onmouseover="this.style.textDecoration='underline';" onmouseout="this.style.textDecoration='none';">DataOrbit</a>
        </p>
    </div>

    <script>
        // Conversation flow state
        let conversationStep = 0;
        let userData = {};
        let isRegisteredUser = false;
        
        // Conversation flow
        const conversationFlow = [
            // Step 0: Check if user is registered
            {
                id: 'check_registration',
                message: "Hi! I'm Aisha, your Takaful assistant. 😊\n\nBefore we begin, are you already a Takaful customer or do you have an account with us?",
                type: 'options',
                options: [
                    {
                        text: "Yes, I'm already a customer",
                        value: 'existing_customer',
                        icon: '👤',
                        desc: 'I have a Takaful account'
                    },
                    {
                        text: "No, I'm new to Takaful",
                        value: 'new_customer',
                        icon: '✨',
                        desc: 'First time getting a quote'
                    }
                ],
                field: 'user_type'
            },
            
            // Step 1a: Existing customer login
            {
                id: 'existing_login',
                message: "Perfect! Let's get you logged in quickly.\n\nWhat's the email address associated with your Takaful account?",
                type: 'input',
                inputType: 'email',
                placeholder: 'your.email@example.com',
                field: 'email',
                validation: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)
            },
            
            // Step 1b: New customer welcome
            {
                id: 'new_customer_welcome',
                message: "Wonderful! Welcome to the Takaful family! 🌟\n\nI'm excited to help you find the perfect Shariah-compliant home insurance. This will only take a few minutes.\n\nLet's start with your name - what should I call you?",
                type: 'input',
                inputType: 'text',
                placeholder: 'Enter your full name',
                field: 'full_name',
                validation: (value) => value.trim().length >= 2
            },
            
            // Step 2: Email for new customers
            {
                id: 'new_customer_email',
                message: (name) => `Nice to meet you, ${name}! 😊\n\nWhat's your email address? I'll use this to send you your quote details.`,
                type: 'input',
                inputType: 'email',
                placeholder: 'your.email@example.com',
                field: 'email',
                validation: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)
            },
            
            // Step 3: Phone number
            {
                id: 'phone_number',
                message: "Great! Now I'll need your phone number in case we need to reach you about your coverage.",
                type: 'input',
                inputType: 'tel',
                placeholder: '+1 (555) 123-4567',
                field: 'phone',
                validation: (value) => value.replace(/\D/g, '').length >= 10
            },
            
            // Step 4: Home address
            {
                id: 'home_address',
                message: "Now let's talk about your home! 🏠\n\nWhat's the full address of the property you'd like to insure?",
                type: 'input',
                inputType: 'text',
                placeholder: '123 Main Street, City, State, ZIP',
                field: 'address',
                validation: (value) => value.trim().length >= 10
            },
            
            // Step 5: Home type
            {
                id: 'home_type',
                message: "Perfect! What type of home is this?",
                type: 'options',
                options: [
                    {
                        text: "Single-Family House",
                        value: 'house',
                        icon: '🏠',
                        desc: 'Detached single-family home'
                    },
                    {
                        text: "Apartment/Condo",
                        value: 'apartment',
                        icon: '🏢',
                        desc: 'Unit in a building or complex'
                    },
                    {
                        text: "Townhouse",
                        value: 'townhouse',
                        icon: '🏘️',
                        desc: 'Attached home in a row'
                    },
                    {
                        text: "Other",
                        value: 'other',
                        icon: '🏗️',
                        desc: 'Different type of property'
                    }
                ],
                field: 'home_type'
            },
            
            // Step 6: Home age
            {
                id: 'home_age',
                message: "When was your home built? This helps us determine the right coverage for you.",
                type: 'options',
                options: [
                    {
                        text: "2020 or newer",
                        value: '2020+',
                        icon: '✨',
                        desc: 'Very new construction'
                    },
                    {
                        text: "2010-2019",
                        value: '2010-2019',
                        icon: '🆕',
                        desc: 'Modern construction'
                    },
                    {
                        text: "2000-2009",
                        value: '2000-2009',
                        icon: '🏠',
                        desc: 'Recent construction'
                    },
                    {
                        text: "1990-1999",
                        value: '1990-1999',
                        icon: '🏘️',
                        desc: 'Established home'
                    },
                    {
                        text: "Before 1990",
                        value: 'pre-1990',
                        icon: '🏛️',
                        desc: 'Mature/historic home'
                    }
                ],
                field: 'home_age'
            },
            
            // Step 7: Estimated home value
            {
                id: 'home_value',
                message: "What's the estimated value of your home? Don't worry if you're not exactly sure - we can adjust this later.",
                type: 'options',
                options: [
                    {
                        text: "Under $200,000",
                        value: '0-200k',
                        icon: '💰',
                        desc: 'Starter home range'
                    },
                    {
                        text: "$200,000 - $400,000",
                        value: '200k-400k',
                        icon: '💎',
                        desc: 'Mid-range home'
                    },
                    {
                        text: "$400,000 - $600,000",
                        value: '400k-600k',
                        icon: '🏆',
                        desc: 'Upper mid-range'
                    },
                    {
                        text: "$600,000 - $1,000,000",
                        value: '600k-1m',
                        icon: '👑',
                        desc: 'Luxury home'
                    },
                    {
                        text: "Over $1,000,000",
                        value: '1m+',
                        icon: '🌟',
                        desc: 'Premium property'
                    }
                ],
                field: 'home_value'
            },
            
            // Step 8: Coverage preference
            {
                id: 'coverage_preference',
                message: "Almost there! What level of protection are you looking for?",
                type: 'options',
                options: [
                    {
                        text: "Essential Coverage",
                        value: 'basic',
                        icon: '🛡️',
                        desc: 'Fire, theft, basic protection'
                    },
                    {
                        text: "Comprehensive Coverage",
                        value: 'standard',
                        icon: '🏠',
                        desc: 'Full protection + natural disasters'
                    },
                    {
                        text: "Premium Coverage",
                        value: 'premium',
                        icon: '💎',
                        desc: 'Maximum protection + valuables'
                    }
                ],
                field: 'coverage_type'
            },
            
            // Step 9: Previous claims
            {
                id: 'previous_claims',
                message: "Last question! Have you filed any home insurance claims in the past 5 years?",
                type: 'options',
                options: [
                    {
                        text: "No claims",
                        value: 'no',
                        icon: '✅',
                        desc: 'Clean insurance history'
                    },
                    {
                        text: "1-2 small claims",
                        value: 'few',
                        icon: '📋',
                        desc: 'Minor claims history'
                    },
                    {
                        text: "Multiple claims",
                        value: 'many',
                        icon: '📑',
                        desc: 'Several claims filed'
                    }
                ],
                field: 'claims_history'
            },
            
            // Step 10: Generate quote
            {
                id: 'generate_quote',
                message: "Alhamdulillah! I have everything I need to calculate your Shariah-compliant home insurance quote.\n\nLet me work on this for you...",
                type: 'loading'
            }
        ];

        function startConversation() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('chatInterface').classList.add('active');
            
            // Start the conversation flow
            setTimeout(() => {
                showNextStep();
            }, 500);
        }

        function showNextStep() {
            const step = conversationFlow[conversationStep];
            if (!step) return;

            updateProgress();
            
            // Check for conditional steps
            if (step.id === 'existing_login' && userData.user_type !== 'existing_customer') {
                conversationStep++;
                showNextStep();
                return;
            }
            
            if (step.id === 'new_customer_welcome' && userData.user_type !== 'new_customer') {
                conversationStep++;
                showNextStep();
                return;
            }

            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                addAgentMessage(step);
                
                if (step.type === 'loading') {
                    handleLoadingStep();
                } else {
                    showInputInterface(step);
                }
            }, 1500);
        }

        function addAgentMessage(step) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent';
            
            let messageText = step.message;
            if (typeof messageText === 'function') {
                messageText = messageText(userData.full_name);
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">🤖</div>
                <div class="message-content">${messageText.replace(/\n/g, '<br>')}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addUserMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            
            messageDiv.innerHTML = `
                <div class="message-content">${text}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showInputInterface(step) {
            hideAllInputs();
            
            if (step.type === 'input') {
                showTextInput(step);
            } else if (step.type === 'options') {
                showOptions(step);
            }
        }

        function showTextInput(step) {
            const textInput = document.getElementById('textInput');
            const userInput = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            
            userInput.type = step.inputType || 'text';
            userInput.placeholder = step.placeholder || 'Type your answer...';
            userInput.value = '';
            
            textInput.classList.add('active');
            userInput.focus();
            
            // Set up validation
            userInput.oninput = function() {
                const isValid = step.validation ? step.validation(this.value) : this.value.trim().length > 0;
                sendBtn.disabled = !isValid;
                sendBtn.style.opacity = isValid ? '1' : '0.5';
            };
            
            // Handle enter key
            userInput.onkeypress = function(e) {
                if (e.key === 'Enter' && !sendBtn.disabled) {
                    sendMessage();
                }
            };
        }

        function showOptions(step) {
            const optionsContainer = document.getElementById('optionsContainer');
            const chatMessages = document.getElementById('chatMessages');
            optionsContainer.innerHTML = '';
            
            // Add class to reduce chat messages height
            chatMessages.classList.add('with-options');
            
            step.options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-button';
                optionDiv.onclick = () => selectOption(option, step);
                
                optionDiv.innerHTML = `
                    <div class="option-icon">${option.icon}</div>
                    <div class="option-text">
                        <div class="option-title">${option.text}</div>
                        <div class="option-desc">${option.desc}</div>
                    </div>
                `;
                
                optionsContainer.appendChild(optionDiv);
            });
            
            optionsContainer.classList.add('active');
        }

        function hideAllInputs() {
            const chatMessages = document.getElementById('chatMessages');
            
            document.getElementById('textInput').classList.remove('active');
            document.getElementById('optionsContainer').classList.remove('active');
            document.getElementById('loadingIndicator').classList.remove('active');
            
            // Remove the height restriction when hiding options
            chatMessages.classList.remove('with-options');
        }

        function sendMessage() {
            const step = conversationFlow[conversationStep];
            const userInput = document.getElementById('userInput');
            const value = userInput.value.trim();
            
            if (!value) return;
            
            // Validate input
            if (step.validation && !step.validation(value)) {
                userInput.style.borderColor = 'var(--error)';
                setTimeout(() => {
                    userInput.style.borderColor = '';
                }, 2000);
                return;
            }
            
            // Add user message
            addUserMessage(value);
            
            // Store data
            userData[step.field] = value;
            
            // Hide input and proceed
            hideAllInputs();
            conversationStep++;
            
            setTimeout(() => {
                showNextStep();
            }, 1000);
        }

        function selectOption(option, step) {
            // Add user message
            addUserMessage(option.text);
            
            // Store data
            userData[step.field] = option.value;
            
            // Hide options and proceed
            hideAllInputs();
            conversationStep++;
            
            setTimeout(() => {
                showNextStep();
            }, 1000);
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function handleLoadingStep() {
            document.getElementById('loadingIndicator').classList.add('active');
            
            // Simulate quote calculation
            setTimeout(() => {
                hideAllInputs();
                showQuoteResult();
            }, 3000);
        }

        function showQuoteResult() {
            // Calculate quote based on user data
            const quote = calculateQuote(userData);
            
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message agent';
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">🤖</div>
                    <div class="message-content">
                        <div style="text-align: center; padding: 1rem 0;">
                            <h3 style="color: var(--deep-blue); font-family: 'Amiri', serif; margin-bottom: 1rem;">
                                Your Shariah-Compliant Quote is Ready! 🎉
                            </h3>
                            <div style="font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, var(--primary-gold), var(--emerald)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 1rem 0;">
                                ${quote.monthly}
                            </div>
                            <div style="color: var(--text-light); margin-bottom: 2rem;">per month</div>
                            
                            <div style="background: var(--cream); border-radius: 15px; padding: 1.5rem; margin: 1rem 0; text-align: left;">
                                <h4 style="color: var(--deep-blue); margin-bottom: 1rem; font-family: 'Amiri', serif;">
                                    ☪ Your Coverage Includes:
                                </h4>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--success);">✓</span> Dwelling protection up to ${quote.coverage}
                                    </li>
                                    <li style="padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--success);">✓</span> Personal property coverage
                                    </li>
                                    <li style="padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--success);">✓</span> Liability protection
                                    </li>
                                    <li style="padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--success);">✓</span> 24/7 claims support
                                    </li>
                                    <li style="padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--success);">✓</span> Shariah-compliant investment
                                    </li>
                                    <li style="padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--success);">✓</span> Community profit sharing
                                    </li>
                                </ul>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(46, 139, 87, 0.1)); border: 1px solid var(--primary-gold); border-radius: 15px; padding: 1rem; margin: 1rem 0; border-left: 4px solid var(--primary-gold);">
                                <h4 style="color: var(--deep-blue); margin-bottom: 0.5rem; font-family: 'Amiri', serif;">
                                    ☪ Islamic Assurance
                                </h4>
                                <p style="color: var(--text-light); font-size: 0.9rem; margin: 0; line-height: 1.5;">
                                    This quote is 100% Shariah-compliant and has been reviewed by our Islamic Advisory Board. 
                                    No riba, no gharar, no haram investments.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Show final options
                setTimeout(() => {
                    showFinalOptions();
                }, 1500);
            }, 2000);
        }

        function showFinalOptions() {
            const optionsContainer = document.getElementById('optionsContainer');
            const chatMessages = document.getElementById('chatMessages');
            optionsContainer.innerHTML = '';
            
            // Add class to reduce chat messages height
            chatMessages.classList.add('with-options');
            
            const finalOptions = [
                {
                    text: "Get This Coverage",
                    icon: '✅',
                    desc: 'Proceed with this quote',
                    action: 'proceed'
                },
                {
                    text: "Customize Coverage",
                    icon: '⚙️',
                    desc: 'Adjust coverage options',
                    action: 'customize'
                },
                {
                    text: "Speak with Agent",
                    icon: '📞',
                    desc: 'Talk to a human specialist',
                    action: 'agent'
                },
                {
                    text: "Email Quote",
                    icon: '📧',
                    desc: 'Send details to my email',
                    action: 'email'
                }
            ];
            
            finalOptions.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-button';
                optionDiv.onclick = () => handleFinalAction(option.action);
                
                optionDiv.innerHTML = `
                    <div class="option-icon">${option.icon}</div>
                    <div class="option-text">
                        <div class="option-title">${option.text}</div>
                        <div class="option-desc">${option.desc}</div>
                    </div>
                `;
                
                optionsContainer.appendChild(optionDiv);
            });
            
            optionsContainer.classList.add('active');
        }

        function calculateQuote(data) {
            let basePrice = 85;
            
            // Home type adjustments
            const homeTypeMultipliers = {
                'house': 1.0,
                'apartment': 0.7,
                'townhouse': 0.85,
                'other': 1.1
            };
            
            // Home value adjustments
            const valueMultipliers = {
                '0-200k': 0.8,
                '200k-400k': 1.0,
                '400k-600k': 1.3,
                '600k-1m': 1.6,
                '1m+': 2.0
            };
            
            // Home age adjustments
            const ageMultipliers = {
                '2020+': 0.85,
                '2010-2019': 0.9,
                '2000-2009': 1.0,
                '1990-1999': 1.1,
                'pre-1990': 1.25
            };
            
            // Coverage type adjustments
            const coverageMultipliers = {
                'basic': 0.8,
                'standard': 1.0,
                'premium': 1.4
            };
            
            // Claims history adjustments
            const claimsMultipliers = {
                'no': 0.9,
                'few': 1.0,
                'many': 1.3
            };
            
            const finalPrice = Math.round(basePrice * 
                (homeTypeMultipliers[data.home_type] || 1.0) *
                (valueMultipliers[data.home_value] || 1.0) *
                (ageMultipliers[data.home_age] || 1.0) *
                (coverageMultipliers[data.coverage_type] || 1.0) *
                (claimsMultipliers[data.claims_history] || 1.0)
            );
            
            // Determine coverage amount
            const coverageAmounts = {
                '0-200k': '200,000',
                '200k-400k': '400,000',
                '400k-600k': '600,000',
                '600k-1m': '800,000',
                '1m+': '1,200,000'
            };
            
            return {
                monthly: finalPrice,
                coverage: coverageAmounts[data.home_value] || '400,000'
            };
        }

        function handleFinalAction(action) {
            hideAllInputs();
            
            switch(action) {
                case 'proceed':
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addAgentMessage({
                            message: "Excellent choice! 🎉\n\nI'm connecting you with our Islamic insurance specialist to finalize your policy. They'll contact you within 30 minutes to complete the process.\n\nBarakallahu feeki for choosing Takaful! Your home will be protected according to Islamic principles.",
                        });
                    }, 1500);
                    break;
                    
                case 'customize':
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addAgentMessage({
                            message: "Of course! Let me connect you with our coverage specialist who can help you customize your policy to perfectly fit your needs and budget.\n\nThey'll call you within 15 minutes to discuss your options.",
                        });
                    }, 1500);
                    break;
                    
                case 'agent':
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addAgentMessage({
                            message: "Perfect! I'm scheduling a call with one of our Takaful specialists right now.\n\nExpect a call from us within the next 10 minutes. Our specialist will have all your information ready and can answer any questions about Islamic insurance principles.\n\nJazakallahu khairan!",
                        });
                    }, 1500);
                    break;
                    
                case 'email':
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addAgentMessage({
                            message: `Great! I've sent your complete Shariah-compliant quote to ${userData.email}.\n\nYou'll receive:\n• Your personalized quote details\n• Coverage breakdown\n• Islamic compliance certificate\n• Next steps to activate your policy\n\nThe email should arrive within the next few minutes. Check your spam folder just in case!\n\nAlhamdulillah, it was wonderful helping you today!`,
                        });
                    }, 1500);
                    break;
            }
        }

        function updateProgress() {
            const totalSteps = conversationFlow.length;
            const progressTexts = [
                'Getting Started',
                'Account Verification',
                'Personal Info',
                'Contact Details', 
                'Home Location',
                'Property Details',
                'Home Age',
                'Property Value',
                'Coverage Selection',
                'Claims History',
                'Calculating Quote'
            ];
            
            const progressText = progressTexts[conversationStep] || 'Almost Done';
            document.getElementById('progressText').textContent = progressText;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add some initial floating elements for ambiance
            setTimeout(() => {
                const greetings = ['Assalamu Alaikum', 'Marhaba', 'Ahlan wa Sahlan'];
                console.log(greetings[Math.floor(Math.random() * greetings.length)] + '! Welcome to Takaful.');
            }, 1000);
        });
    </script>
</body>
</html>